# Common Configuration for Grafana Deployment
# This file contains shared configuration for the official Grafana chart

# =============================================================================
# SHARED ENVIRONMENT VARIABLES
# =============================================================================
common:
  # Cluster environment
  cluster:
    type: "microk8s"
    version: "v1.32.9"
    node_ip: "10.110.40.193"
    storage_class: "microk8s-hostpath"
  
  # Namespace configuration
  namespace: "grafana"
  
  # Access configuration
  access:
    protocol: "http"
    port: "30030"
    url: "http://10.110.40.193:30030"
  
  # Database configuration
  database:
    type: "postgresql"
    host: "postgres-postgresql.postgres.svc.cluster.local"
    port: "5432"
    name: "grafana"
    user: "grafana"
    password: "grafana_password123"
    ssl_mode: "disable"
    connection_string: "postgres://grafana:grafana_password123@postgres-postgresql.postgres.svc.cluster.local:5432/grafana?sslmode=disable"
  
  # Admin credentials
  admin:
    user: "admin"
    # Admin password is auto-generated by Helm and stored in Kubernetes secret
    # Retrieve password with: kubectl get secret grafana -n grafana -o jsonpath='{.data.admin-password}' | base64 -d
  
  # Resource configuration
  resources:
    cpu:
      request: "250m"
      limit: "500m"
    memory:
      request: "256Mi"
      limit: "512Mi"
  
  # Storage configuration
  storage:
    enabled: true
    size: "10Gi"
    storage_class: "microk8s-hostpath"
    access_modes: ["ReadWriteOnce"]
  
  # Security context
  security:
    pod_security_context:
      fs_group: 1001
    container_security_context:
      run_as_user: 1001
      run_as_non_root: true
      allow_privilege_escalation: false
      capabilities:
        drop: ["ALL"]

# =============================================================================
# VERIFICATION CONFIGURATION
# =============================================================================
verification:
  # Health check endpoints
  health:
    endpoint: "/api/health"
    timeout: 30
    retries: 5
  
  # Database verification
  database:
    table_check_timeout: 60
    connection_timeout: 30
  
  # Access verification
  access:
    login_timeout: 30
    ui_load_timeout: 60

# =============================================================================
# CLEANUP CONFIGURATION
# =============================================================================
cleanup:
  # Resources to remove
  remove_pvc: false
  remove_secrets: false
  remove_configmaps: false
  remove_rbac: true
  
  # Timeout for cleanup operations
  timeout: 300

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
logging:
  level: "info"
  format: "json"
  
  # Log retention
  retention:
    days: 7
    max_size: "100MB"

# =============================================================================
# MONITORING CONFIGURATION
# =============================================================================
monitoring:
  enabled: false
  
  # Metrics configuration
  metrics:
    enabled: false
    port: 9090
    path: "/metrics"
  
  # Service monitor
  service_monitor:
    enabled: false
    interval: "30s"
    scrape_timeout: "10s"

# =============================================================================
# BACKUP CONFIGURATION
# =============================================================================
backup:
  enabled: false
  
  # Backup schedule
  schedule: "0 2 * * *"  # Daily at 2 AM
  
  # Retention policy
  retention:
    days: 30
    copies: 10

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================
security:
  # Network policies
  network_policy:
    enabled: false
  
  # Pod security standards
  pod_security:
    standards: "baseline"
  
  # TLS configuration
  tls:
    enabled: false
    auto_generated: false

# =============================================================================
# FEATURE FLAGS
# =============================================================================
features:
  # Grafana features
  ldap: false
  smtp: false
  enterprise: false
  
  # Deployment features
  autoscaling: false
  ingress: false
  metrics: false
  
  # Development features
  debug: false
  dry_run: false

# =============================================================================
# CHART-SPECIFIC CONFIGURATION MAPPINGS
# =============================================================================
chart_mappings:
  # Official chart specific mappings
  official:
    database_config: "grafana.ini.database"
    admin_config: "grafana.adminUser"
    service_config: "service"
    persistence_config: "persistence"

# =============================================================================
# VALIDATION RULES
# =============================================================================
validation:
  # Required fields
  required:
    - database.host
    - database.password
    - access.port
    - storage.storage_class
  
  # Validation rules
  rules:
    - name: "database_host_reachable"
      description: "Database host must be reachable"
      type: "connectivity"
    
    - name: "port_available"
      description: "NodePort must be available"
      type: "port_check"
    
    - name: "storage_class_exists"
      description: "Storage class must exist"
      type: "resource_check"
    
    - name: "password_strength"
      description: "Admin password must be strong"
      type: "password_policy"

# =============================================================================
# ERROR HANDLING
# =============================================================================
error_handling:
  # Retry configuration
  retry:
    max_attempts: 3
    backoff: "exponential"
    initial_delay: 5
    max_delay: 60
  
  # Error severity levels
  severity:
    critical: ["database_connection", "authentication", "persistent_storage"]
    warning: ["resource_limits", "probe_configuration", "service_access"]
    info: ["configuration_validation", "deployment_progress"]

# =============================================================================
# SUCCESS CRITERIA
# =============================================================================
success_criteria:
  # Functional requirements
  functional:
    - grafana_deployed
    - database_connected
    - admin_login_working
    - ui_accessible
  
  # Technical requirements
  technical:
    - pod_ready
    - storage_mounted
    - resource_limits_applied
    - nodeport_correct
    - probes_working
  
  # Quality requirements
  quality:
    - no_errors_in_logs
    - all_tests_passing
    - configuration_valid
    - security_compliant

# =============================================================================
# TROUBLESHOOTING GUIDES
# =============================================================================
troubleshooting:
  # Common issues and solutions
  common_issues:
    database_connection:
      symptoms: ["SQLite database file created", "PostgreSQL tables missing"]
      causes: ["Incorrect database configuration", "Network connectivity issues"]
      solutions: ["Check database configuration format", "Verify network policies"]
    
    nodeport_assignment:
      symptoms: ["Wrong NodePort assigned", "Service not accessible"]
      causes: ["Port conflicts", "Incorrect service configuration"]
      solutions: ["Check port availability", "Verify service configuration"]
    
    probe_failures:
      symptoms: ["Pod not ready", "Probe errors in logs"]
      causes: ["Incorrect probe configuration", "Port name instead of number"]
      solutions: ["Use port numbers in probes", "Check probe paths"]

# =============================================================================
# MAINTENANCE PROCEDURES
# =============================================================================
maintenance:
  # Regular maintenance tasks
  regular:
    - name: "Update charts"
      frequency: "weekly"
      description: "Update Helm charts to latest versions"
    
    - name: "Check resource usage"
      frequency: "daily"
      description: "Monitor CPU and memory usage"
    
    - name: "Backup configuration"
      frequency: "weekly"
      description: "Backup Grafana configuration and data"
  
  # Emergency procedures
  emergency:
    - name: "Rollback deployment"
      description: "Rollback to previous working version"
      severity: "critical"
    
    - name: "Restore from backup"
      description: "Restore Grafana data from backup"
      severity: "critical"

# =============================================================================
# VERSION COMPATIBILITY
# =============================================================================
compatibility:
  # Supported versions
  kubernetes: ">=1.24.0"
  helm: ">=3.8.0"
  grafana: ">=10.0.0"
  postgresql: ">=12.0"
  
  # Tested combinations
  tested:
    - kubernetes: "v1.32.9"
      helm: "v4.0.1"
      grafana: "v12.3.0"
      chart: "official"